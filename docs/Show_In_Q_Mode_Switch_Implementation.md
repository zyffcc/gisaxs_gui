# Show in Q模式切换功能完整实现

## 功能概述
实现了"Show in q"按钮切换时的完整功能，包括参数转换、显示更新和Cut结果刷新。

## 主要功能

### 1. **参数自动转换**
- **无论是否有Cut data，都会转换Cut line和Center的四个数值**
- **Pixel → Q-space转换**: 使用`pixel_to_q_space`方法
- **Q-space → Pixel转换**: 使用新实现的`q_to_pixel_space`方法
- **智能转换**: 避免重复转换，只在模式真正改变时执行

### 2. **显示同步更新**
- **二维图更新**: 如果有图像显示，自动更新主界面和外置窗口的二维图
- **坐标系切换**: 在pixel坐标系和Q空间坐标系间无缝切换
- **轴标签更新**: 自动更新坐标轴标签和单位

### 3. **Cut结果刷新**
- **一维Cut图更新**: 如果有Cut data，自动重新计算并更新一维图
- **主界面同步**: 更新fitGraphicsView中的Cut结果
- **独立窗口同步**: 同时更新独立matplotlib窗口中的Cut结果

## 技术实现

### 新增反向转换函数

#### `q_to_pixel_space()` - Q空间到像素坐标转换
```python
def q_to_pixel_space(self, qx, qy, qz):
    """将q空间坐标转换为detector像素坐标"""
```

**实现原理**:
1. 从q向量反推散射角度和方位角
2. 转换为物理坐标系
3. 映射到像素坐标系

**数学模型**:
- `sin_theta_sc = (qz / k0) - sin(theta_in)`
- `sin_psi = qy / (k0 * cos(theta_sc))`
- 处理符号歧义和角度计算
- 转换为像素坐标

### 核心控制函数

#### `_update_parameter_values_for_q_axis()` - 完整重写
**功能流程**:
1. **检测模式切换**: 判断是否需要转换
2. **参数转换**: 调用相应的转换函数
3. **UI更新**: 暂时断开信号，更新数值，重新连接
4. **显示刷新**: 更新二维图和外置窗口
5. **Cut刷新**: 重新计算一维Cut结果

#### 转换函数实现
- **`_convert_pixel_to_q_parameters()`**: Pixel→Q转换
- **`_convert_q_to_pixel_parameters()`**: Q→Pixel转换
- **`_get_detector_for_conversion()`**: 创建转换用detector

### 信号管理
- **`_temporarily_disconnect_parameter_signals()`**: 暂停信号连接
- **`_reconnect_parameter_signals()`**: 恢复信号连接
- **避免循环触发**: 防止参数更新时触发无限循环

## 使用场景

### 场景1: 只有图像数据，无Cut结果
1. 切换"Show in q"按钮
2. ✅ 转换Cut line和Center参数
3. ✅ 更新二维图显示和坐标轴
4. ✅ 更新外置窗口（如果开启）
5. ❌ 无Cut结果需要更新

### 场景2: 有图像数据和Cut结果
1. 切换"Show in q"按钮
2. ✅ 转换Cut line和Center参数
3. ✅ 更新二维图显示和坐标轴
4. ✅ 更新外置窗口（如果开启）
5. ✅ 重新计算并显示Cut结果
6. ✅ 同步更新独立拟合窗口

### 场景3: 无图像数据
1. 切换"Show in q"按钮
2. ❌ 提示"无图像数据，无法进行坐标转换"
3. ✅ 仍然更新步长和标签

## 错误处理

### 1. **数据验证**
- 检查图像数据存在性
- 验证detector参数完整性
- 处理坐标转换异常

### 2. **转换保护**
- 重复转换检测机制
- 异常情况回退原值
- 信号连接保护

### 3. **用户反馈**
- 清晰的状态提示信息
- 转换成功/失败通知
- 操作指导建议

## 性能优化

### 1. **智能缓存**
- detector对象重用
- 避免重复计算
- 模式状态跟踪

### 2. **信号管理**
- 临时断开连接避免循环
- 批量更新UI控件
- 延迟显示刷新

### 3. **计算优化**
- 仅在需要时进行转换
- 参数校验前置
- 异常快速返回

## 数学精度

### 1. **坐标转换精度**
- 双精度浮点计算
- 三角函数精确处理
- 符号歧义解决

### 2. **参数映射**
- Center点精确转换
- Cut Line尺寸准确计算
- 边界条件处理

### 3. **误差控制**
- 数值稳定性保证
- 舍入误差最小化
- 边界值检查

## 用户体验

### 1. **无缝切换**
- 参数自动转换，用户无需手动修改
- 显示立即更新，无延迟感
- 保持工作流程连续性

### 2. **智能提示**
- 明确的状态反馈
- 错误情况指导
- 操作结果确认

### 3. **数据完整性**
- 转换过程中数据不丢失
- Cut结果自动同步
- 独立窗口实时更新

这个实现完全满足了用户的需求：切换"Show in q"按钮时，无论什么情况都会智能地转换参数，更新显示，并刷新所有相关结果。
