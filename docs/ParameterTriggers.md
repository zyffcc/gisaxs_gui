# 参数触发机制说明

## 概述

为了改善用户体验，参数控件的保存触发机制已从"实时触发"改为"智能触发"，避免了输入过程中的频繁保存操作。

## 三种触发方式

### 1. 回车键触发 ⌨️
- **触发条件**: 在参数输入框中按回车键
- **响应时间**: 立即（0ms）
- **保存方式**: 立即保存到内存和文件  
- **适用场景**: 精确输入特定数值
- **用户反馈**: INFO级别日志消息

```
用户操作: 输入 "3.14159" → 按回车
系统响应: 立即保存 → 显示 "Parameter radius for particle 1 saved: 3.14159"
```

### 2. 焦点丢失触发 🖱️
- **触发条件**: 鼠标点击其他控件或区域
- **响应时间**: 立即（0ms）
- **保存方式**: 立即保存到内存和文件
- **适用场景**: 修改参数后切换到其他控件
- **用户反馈**: INFO级别日志消息

```
用户操作: 修改参数 → 点击其他地方
系统响应: 自动保存 → 无需手动确认
```

### 3. 滚轮触发 🖱️💫
- **触发条件**: 鼠标滚轮调整数值
- **响应时间**: 延迟300ms
- **保存方式**: 延迟保存到内存，异步保存到文件
- **适用场景**: 连续微调参数值
- **用户反馈**: DEBUG级别日志消息（减少噪音）

```
用户操作: 连续滚动滚轮调整数值
系统响应: 等待停止滚动300ms → 保存最终值
```

## 防抖机制 🛡️

### 滚轮防抖
- **目的**: 防止滚轮快速滚动时频繁触发保存
- **实现**: 每次滚轮事件重置300ms定时器
- **效果**: 只在最后一次滚动后保存

### 独立定时器
- **粒子参数**: 每个控件独立的`_wheel_timers[widget_key]`
- **全局参数**: 每个参数独立的`_global_wheel_timers[param]`
- **文件保存**: 全局共享的`_save_timer`（500ms延迟）

## 性能优化 ⚡

### 立即保存 vs 延迟保存
| 触发方式 | 内存保存 | 文件保存 | 性能影响 |
|----------|----------|----------|----------|
| 回车键   | 立即     | 立即     | 低       |
| 焦点丢失 | 立即     | 立即     | 低       |
| 滚轮     | 延迟300ms| 延迟500ms| 很低     |

### I/O优化
- 滚轮操作使用异步文件保存，避免界面阻塞
- 文件保存定时器会重置，合并频繁的保存操作
- 立即触发（回车/焦点）直接保存，确保数据不丢失

## 技术实现 🔧

### 信号连接
```python
# 回车和焦点丢失
widget.editingFinished.connect(handler_immediate)

# 滚轮（带延迟）
widget.valueChanged.connect(handler_delayed)
timer.timeout.connect(handler_wheel)
```

### 控件识别
- **粒子参数**: `widget_key = f"{widget_id}_{shape}_{param}"`
- **全局参数**: `param` (sigma_res, k_value)

### 日志级别
- **INFO**: 立即保存操作（回车、焦点丢失）
- **DEBUG**: 延迟保存操作（滚轮）
- **ERROR**: 所有保存失败情况

## 用户指南 📖

### 推荐使用方式

1. **精确输入** → 使用键盘输入 + 回车键
   ```
   输入框中输入: 2.718281828
   按回车确认 → 立即保存
   ```

2. **快速调整** → 使用鼠标滚轮
   ```
   鼠标悬停在参数框
   滚轮向上/向下调整
   停止滚动 → 自动保存
   ```

3. **批量修改** → Tab键切换 + 自动保存
   ```
   修改参数1 → Tab切换 → 自动保存参数1
   修改参数2 → Tab切换 → 自动保存参数2
   ```

### 特殊输入支持
- **科学记数法**: `1.5e-6`, `2.1E+8`
- **负数**: `-123.456`
- **大数值**: `1000000.789`
- **高精度**: `3.141592653589793`

## 故障排除 🔍

### 常见问题

**Q: 参数没有保存？**
A: 确保使用了触发方式：回车键、点击其他地方，或等待滚轮延迟

**Q: 滚轮调整太敏感？**
A: 滚轮有300ms延迟，停止滚动后会自动保存最终值

**Q: 输入过程中就触发保存？**
A: 新机制避免了这个问题，只在确认输入后才保存

### 调试信息
- 查看日志中的INFO消息确认立即保存
- 查看DEBUG消息确认滚轮延迟保存
- 检查ERROR消息排查保存失败问题

## 兼容性 🔄

- ✅ 完全兼容现有的参数保存/加载系统
- ✅ 保持与模型参数管理器的集成
- ✅ 支持所有现有的参数控件
- ✅ 向后兼容之前保存的参数文件